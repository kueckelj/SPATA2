---
title: "Clustering"
output:
  html_document:
    theme: flatly
    df_print: paged
    css: "markdown-styles.css"
    toc: true
    toc_depth: 3

---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, fig.show = "hold", out.width = "50%", message = FALSE, warning = FALSE)

```

## 1. Prerequisites

None. 

## 2. Introduction

Grouping variables divide the barcode-spots of sample into groups whose properties can be compared against each other. For instance, the grouping of barcode-spots can be the result of clustering algorithms or manual spatial segmentation. This tutorial shows how to apply and add clustering in **SPATA2**.

```{r echo = F, eval = T}

devtools::load_all()
library(tidyverse)

object_t313 <- loadSpataObject("data/object_UKF313T.RDS")

meta <- object_t313@meta_obs

object_t313@meta_obs <- select(meta, barcodes, sample)

```

```{r eval = F, fig.dim = c(9, 9), fig.cap = "Fig.1 Different resolutions result in different x- and y-scale." }

library(SPATA2)
library(SPATAData)
library(tidyverse)

# download object
object_t313 <- 
  downloadFromPublication(pub = "kueckelhaus_et_al_2024", id = "UKF313T", raw = TRUE)

plotImage(object_t313)

```

```{r fig.cap = "Fig.1 The histology of sample UKF313T."}

plotImage(object_t313)

```


## 3. Clustering within SPATA2

There are several algorithms out there that can be used to divide your sample into subgroups. SPATA2 provides wrappers around several clustering algorithms. Cluster algorithms that add their results immediately to the `SPATA2` object are prefixed with with `run-*` and suffixed with `*-Clustering()`. E.g. `runBayesSpaceClustering()`, `runKmeansClustering()`, `runSeuratClustering()`. 

```{r}

# current grouping options (none)
getGroupingOptions(object_t313)

```
Argument `name` or `naming` specifies the name of the output grouping variable. The resulting grouping variable names are available with `getGroupingOptions()`.  

```{r echo = T, eval = F}

# run the pipeline
object_t313 <- 
  runBayesSpaceClustering(
    object = object_t313, 
    name = "bayes_space" # the name of the output grouping variable
  )

object_t313 <- 
  runKmeansClustering(
    object = object_t313, 
    ks = c(7, 8), 
    methods_kmeans = "Lloyd"
  )

# results are immediately stored in the objects feature data
getGroupingOptions(object_t313)

```

```{r echo = F, eval = T}

object_t313@meta_obs <- meta[,c("barcodes", "sample", "bayes_space")]

object_t313 <- 
  runKmeansClustering(
    object = object_t313, 
    ks = c(7, 8), 
    methods_kmeans = "Lloyd"
  )

getGroupingOptions(object_t313)

```

```{r fig.cap = "Fig.2 Differnt clustering results."}

plotSurface(
  object = object_t313, 
  color_by = "bayes_space", 
  pt_clrp = "uc"
)

plotSurface(
  object = object_t313, 
  color_by = "Lloyd_k7",
  pt_clrp = "jco"
  )

```


## 4. Clustering outside of SPATA2

Clustering can result from a multitude of cluster algorithms. If they are not implemented
in SPATA2 functions you can add them using the `addFeatures()` function.


```{r}

# uses kmeans outside of SPATA2
kmeans_res <- 
  stats::kmeans(
    x = getPcaMtr(object_t313), 
    centers = 7, 
    algorithm = "Hartigan-Wong"
  )

head(kmeans_res[["cluster"]])

cluster_df <- 
  as.data.frame(kmeans_res[["cluster"]]) %>% 
  tibble::rownames_to_column(var = "barcodes") %>% 
  magrittr::set_colnames(value = c("barcodes", "kmeans_4_HW")) %>% 
  tibble::as_tibble()

cluster_df[["kmeans_4_HW"]] <- as.factor(cluster_df[["kmeans_4_HW"]])

cluster_df

```

Only requirement is a *barcodes* variable to map the groups to the observations. Note that a variable must be of class factor in order to be recognized as a grouping variable.

```{r}

# grouping options before adding
getGroupingOptions(object_t313)

# add the cluster results to the meta features
object_t313 <- 
  addFeatures(
    object = object_t313,
    feature_df = cluster_df
    )

# grouping options names afterwards
getGroupingOptions(object_t313)

```

Continue by visualizing your results or by investigating their transcriptional characteristics using [differentially expressed analysis (DEA)](spata-v2-dea.html)).

```{r fig.show = "hold", out.width = "50%", fig.cap = "Fig.3 Leiden clustering results"}

plotSurface(
  object = object_t313,
  color_by = "kmeans_4_HW",
  pt_clrp = "jama"
  ) +
  labs(color = "Kmeans HW")

```

