---
title: "Adding Data to SPATA2 objects"
output:
  html_document:
    theme: flatly
    df_print: paged
    css: "markdown-styles.css"
    toc: true
    toc_depth: 3

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, echo = TRUE, eval = TRUE, class.source = "code-chunk", out.width = "50%", fig.show = "hold")

devtools::load_all()
library(tidyverse)
library(patchwork)

object_t269 <- loadSpataObject("data/object_UKF269T.RDS")

```

## 1. Prerequisites

None. 

## 2. Introduction  

While SPATA2 provides wrappers for multiple algorithms, you can always add data from external sources and packages. Depending on the kind of data you want to add, different functions are required. 

```{r eval = F}

library(SPATA2)
library(SPATAData)
library(tidyverse)

# download sample UKF269T
object_t269 <- downloadFromPublication(pub = "kueckelhaus_et_al_2024", id = "UKF269T")

```

## 3. Data matrices

Assuming you have a data matrix processed with functions from a different package (e.g. Seurat), you can add them to the SPATA2 object via the function `addProcessedMatrix()`. 

```{r fig.cap = "Fig.1 Comparison between EGFR expression displayed with raw counts and scaled expression."}
library(Seurat)

# create Seurat object from count matrix
count_mtr <- getCountMatrix(object_t269)

seurat_obj <- CreateSeuratObject(count_mtr)
seurat_obj <- NormalizeData(seurat_obj)
seurat_obj <- ScaleData(seurat_obj)

scaled_mtr <- GetAssayData(seurat_obj, layer = "scale.data")

# show a small subset of the scaled mtr 
scaled_mtr[1:5, 1:5]

# add the processed matrix to SPATA2 object under the name 'scaled'
object_t269 <- 
  addProcessedMatrix(
    object = object_t269,
    proc_mtr = scaled_mtr,
    mtr_name = "scaled"  
    )

# the matrix is now accessible next to all other matrices
# ('counts' refers to the raw count matrix with which the SPATA2 object has been initated)
getMatrixNames(object_t269)

# check which matrix is currently active
activeMatrix(object_t269)

# create a surface plot with EGFR expression using raw counts 
egfr_counts <- 
  plotSurface(object_t269, color_by = "EGFR") + 
  labs(subtitle = "Matrix: raw counts")

# activate the processes matrix to make functions pick it by default
object_t269 <- activateMatrix(object_t269, mtr_name = "scaled")
activeMatrix(object_t269)

# create a surface plot with EGFR expression using scaled expression
egfr_scaled <- 
  plotSurface(object_t269, color_by = "EGFR") + 
  labs(subtitle = "Matrix: scaled by seurat")

# show plots
egfr_counts
egfr_scaled

```

## 4. Features

Features that are not raw or processed molecular counts, like clustering or certain scores, are stored in the meta data.frame of the `SPATA2` object, as obtained by `getMetaDf()`. SPATA2 intern functions like `runBayesSpaceClustering()` or `runCNV()` add the results automatically to this data.frame. The following code chunk creates a data.frame of meta SPATA2 extern created meta features that can be added to the `SPATA2` object.  

```{r}

seurat_obj <- FindVariableFeatures(seurat_obj)
seurat_obj <- RunPCA(seurat_obj)
seurat_obj <- FindNeighbors(seurat_obj)
seurat_obj <- FindClusters(seurat_obj)

# add rownames as 'barcodes' variable 
seurat_meta_df <- 
  tibble::rownames_to_column(seurat_obj@meta.data, var = "barcodes") %>% 
  tibble::as_tibble()

# show meta df
seurat_meta_df

```

The meta data.frame from the `Seurat` object contains cluster results as well as summarizing numeric variables like *nCount_RNA* and *nFeature_RNA*. These variables can be added to the `SPATA2` object and are afterwards accessible with all SPATA2 functions.  

```{r fig.dim = c(6,6), fig.cap = "Surface plots with features added from other packages."}

# add features from the data.frame 
object_t269 <- 
  addFeatures(
    object = object_t269,
    feature_df = seurat_meta_df, 
    feature_names = c("nCount_RNA", "seurat_clusters"), 
    overwrite = TRUE
    )

# once added, they are accessible for all SPATA2 functions 
plotSurface(object_t269, color_by = "nCount_RNA")  
plotSurface(object_t269, color_by = "seurat_clusters", pt_clrp = "sifre") 

```

Grouping variables such as the *seurat_clusters* variable can be used for comparative analysis. 

```{r out.width = "100%", fig.dim = c(9, 6), fig.cap = "Fig.3 Comparative analysis using the added features."}

plotBoxplot(object_t269, variables = "nCount_RNA", across = "seurat_clusters", clrp = "sifre") + 
 legendNone() + 
 labs(x = "seurat clusters")

```

## 5. Images 

To learn how to register additional images in the `SPATA2` object please refer to the vignette [2D Space and Images](2d-space-and-images.html) in SPATA2. 
